<!DOCTYPE html>
<html lang="en">
<%- include('components/head') %>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<body class="bg-neutral-950 text-gray-300 font-[Figtree] min-h-screen flex">

  <!-- Sidebar -->
  <%- include('components/sidebar.ejs') %>

  <!-- Main Content -->
  <div class="flex-1 flex flex-col">

    <!-- Navbar -->
    <%- include('components/nav.ejs') %>

    <!-- VPS Dashboard -->
    <main class="p-6 flex flex-col space-y-6">
    <%- include('components/vpsnav.ejs') %>
    <% if (server.ssh && server.ssh.includes('localhost')) { %>
  <div class="bg-blue-600 text-white p-4 rounded-lg flex flex-col md:flex-row items-start md:items-center space-y-2 md:space-y-0 md:space-x-2 mb-4">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 20a8 8 0 100-16 8 8 0 000 16z" />
    </svg>
    <div class="flex flex-col">
      <span class="font-semibold text-lg">BETA RDPs</span>
      <span class="text-sm text-blue-100">
       RDP instances are localhost-only, connect using IPv4:PORT; expect limited features/instability, and for Windows 98 use at least 512 MB RAM if connection fails.
      </span>
    </div>
  </div>
<% } %>
      <!-- Server Info -->
      <div class="bg-neutral-950 p-6 rounded-2xl shadow-lg border border-[#2a2a2a] flex flex-col space-y-4">
        <h1 class="text-3xl font-bold text-gray-200">
          <%= server.name || "Unnamed VPS" %>
        </h1>

        <div class="flex items-center space-x-2 text-sm md:text-base">
          <span class="font-semibold">Access:</span>
          <% if (server.ssh) { %>
            <% if (server.ssh.includes('localhost')) { %>
              <!-- RDP (via noVNC) -->
              <a href="http://<%= server.ssh %>/vnc.html" target="_blank"
                class="px-3 py-1 bg-neutral-700 rounded text-blue-400 font-mono whitespace-nowrap hover:underline">
                <%= server.ssh %>/vnc.html
              </a>
              <% } else { %>
                <!-- Normal SSH -->
                <span class="px-3 py-1 bg-neutral-700 rounded text-green-400 font-mono whitespace-nowrap">
                 <%= serverip %>
                </span>
                <% } %>
                  <% } else { %>
                    <span class="px-3 py-1 bg-neutral-700 rounded text-gray-500 italic">N/A</span>
                    <% } %>
        </div>

        <!-- Uptime -->
        <div class="flex items-center space-x-2 text-sm md:text-base">
          <span class="font-semibold">Uptime:</span>
          <span id="uptime-display" class="px-3 py-1 bg-neutral-700 rounded text-blue-400 font-mono whitespace-nowrap">
            Loading...
          </span>
        </div>

        <!-- Status -->
        <div class="flex items-center space-x-2 text-sm md:text-base">
          <span class="font-semibold">Status:</span>
          <span id="vps-status" class="px-4 py-2 rounded font-semibold text-lg bg-gray-500 text-white">
            Loading
          </span>
        </div>
      </div>

      <!-- Controls -->
      <div class="bg-neutral-950 p-6 rounded-2xl shadow-lg border border-[#2a2a2a] flex flex-col space-y-4">
        <h2 class="text-xl font-semibold text-gray-200">Controls</h2>
        <div class="flex flex-wrap gap-3">
        
          <!--button id="btn-ressh"
            class="px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition disabled:opacity-50">Ressh</button-->
          <button id="btn-start"
            class="px-5 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold transition disabled:opacity-50">Start</button>
          <button id="btn-stop"
            class="px-5 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold transition disabled:opacity-50">Stop</button>
          <button id="btn-restart"
            class="px-5 py-2.5 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 font-semibold transition disabled:opacity-50">Restart</button>
        </div>

        <!-- Logs -->
        <div class="mt-6">
          <h3 class="text-lg font-semibold text-gray-200 mb-2">Logs</h3>
          <div id="logContainer" class="bg-neutral-950 border border-[#2a2a2a] rounded-lg p-3 h-60 overflow-y-auto font-mono text-sm space-y-1"></div>
        </div>
      </div>

      <!-- Charts -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- CPU -->
        <div class="bg-neutral-950 rounded-2xl p-6 shadow-lg border border-[#2a2a2a]">
          <h2 class="text-xl font-semibold text-gray-200 mb-4">CPU Usage</h2>
          <canvas id="cpuChart" class="w-full h-64"></canvas>
        </div>

        <!-- RAM -->
        <div class="bg-neutral-950 rounded-2xl p-6 shadow-lg border border-[#2a2a2a]">
          <h2 class="text-xl font-semibold text-gray-200 mb-4">RAM Usage</h2>
          <canvas id="ramChart" class="w-full h-64"></canvas>
        </div>

        <!-- Disk -->
        <div class="bg-neutral-950 rounded-2xl p-6 shadow-lg border border-[#2a2a2a]">
          <h2 class="text-xl font-semibold text-gray-200 mb-4">Disk Usage</h2>
          <canvas id="diskChart" class="w-full h-64"></canvas>
        </div>
        <!-- Network -->
        <div class="bg-neutral-950 rounded-2xl p-6 shadow-lg border border-[#2a2a2a]">
          <h2 class="text-xl font-semibold text-gray-200 mb-4">Network Usage</h2>
          <canvas id="networkChart" class="w-full h-64"></canvas>
        </div>

      </div>
    </main>
  </div>

<script>
lucide.createIcons();

const containerId = "<%= server.containerId %>";

// Chart.js base options
const baseOptions = {
  responsive: true,
  animation: false,
  plugins: {
    legend: { display: false },
    title: { display: false },
    tooltip: {
      enabled: true, // âœ… show tooltips
      backgroundColor: "rgb(23,23,23)", // ~bg-neutral-900
      titleColor: "#e5e7eb",            // gray-200
      bodyColor: "#d1d5db",             // gray-300
      borderColor: "#2a2a2a",      
      borderWidth: 1,
      displayColors: false, // removes color box (can set true if you want dataset color too)
      callbacks: {
        title: () => null,
        label: (context) => {
          // Show all parsed values from dataset
          let lines = [];
          if (context.dataset.label) {
            lines.push(`${context.dataset.label}: ${context.formattedValue}`);
          } else {
            // fallback: show all parsed key/value pairs
            const parsed = context.parsed;
            for (const key in parsed) {
              lines.push(`${key}: ${parsed[key]}`);
            }
          }
          return lines;
        },
      },
    },
  },
  layout: { padding: 0 },
  scales: {
    x: {
      min: 0,
      max: 19,
      type: "linear",
      grid: { display: false, drawBorder: false },
      ticks: { display: false },
    },
    y: {
      min: 0,
      type: "linear",
      grid: {
        display: true,
        color: getTailwindColor("gray", 700),
        drawBorder: false,
      },
      ticks: {
        display: true,
        count: 3,
        color: getTailwindColor("gray", 200),
        font: {
          family: "'Figtree', sans-serif",
          size: 11,
          weight: "400",
        },
      },
    },
  },
  elements: {
    point: { radius: 0, hitRadius: 20 },
    line: { tension: 0.15 },
  },
};

// Tailwind gray helper
function getTailwindColor(color, shade) {
  const colors = {
    gray: { 200: "#e5e7eb", 700: "#374151" },
  };
  return colors[color]?.[shade] || "#ccc";
}

const labels = Array.from({ length: 20 }, (_, i) => i);

// Chart datasets
const cpuData = {
  labels,
  datasets: [
    {
      label: "CPU %",
      data: Array(20).fill(0),
      borderColor: "rgb(34,197,94)",
      backgroundColor: "rgba(34,197,94,0.2)",
      tension: 0.3,
    },
  ],
};
const ramData = {
  labels,
  datasets: [
    {
      label: "RAM MB",
      data: Array(20).fill(0),
      borderColor: "rgb(59,130,246)",
      backgroundColor: "rgba(59,130,246,0.2)",
      tension: 0.3,
    },
  ],
};
const diskData = {
  labels,
  datasets: [
    {
      label: "Disk MB",
      data: Array(20).fill(0),
      borderColor: "rgb(245,158,11)",
      backgroundColor: "rgba(245,158,11,0.2)",
      tension: 0.3,
    },
  ],
};
const networkData = {
  labels,
  datasets: [
    {
      label: "Inbound MB",
      data: Array(20).fill(0),
      borderColor: "rgb(59,130,246)",
      backgroundColor: "rgba(59,130,246,0.2)",
      tension: 0.3,
    },
    {
      label: "Outbound MB",
      data: Array(20).fill(0),
      borderColor: "rgb(168,85,247)",
      backgroundColor: "rgba(168,85,247,0.2)",
      tension: 0.3,
    },
  ],
};

// Initialize charts
const cpuChart = new Chart(document.getElementById("cpuChart"), {
  type: "line",
  data: cpuData,
  options: baseOptions,
});
const ramChart = new Chart(document.getElementById("ramChart"), {
  type: "line",
  data: ramData,
  options: baseOptions,
});
const diskChart = new Chart(document.getElementById("diskChart"), {
  type: "line",
  data: diskData,
  options: baseOptions,
});
const networkChart = new Chart(document.getElementById("networkChart"), {
  type: "line",
  data: networkData,
  options: baseOptions,
});

// --- Buttons ---
<% if (!server.ssh.includes('localhost')) { %>
const btnRessh = document.getElementById("btn-ressh");
<% } %>
const btnStart = document.getElementById("btn-start");
const btnStop = document.getElementById("btn-stop");
const btnRestart = document.getElementById("btn-restart");

// --- Logs ---
const logContainer = document.getElementById("logContainer");
const logColors = {
  INFO: "#d4d4d4",
  ACTION: "#38bdf8",
  ERROR: "#ef4444",
  SUCCESS: "#10b981",
};
function addLog(type, message) {
  const line = document.createElement("div");
  line.classList.add("flex", "items-center", "gap-2");

  const badge = document.createElement("span");
  badge.textContent = type;
  badge.className = "px-2 py-0.5 text-xs font-semibold uppercase rounded";
  badge.style.color = logColors[type] || "#d4d4d4";
  badge.style.backgroundColor = hexToAlpha(
    logColors[type] || "#d4d4d4",
    0.1
  );

  const text = document.createElement("span");
  text.textContent = message;

  line.appendChild(badge);
  line.appendChild(text);
  logContainer.appendChild(line);
  logContainer.scrollTop = logContainer.scrollHeight;
}
function hexToAlpha(hex, alpha) {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return `rgba(${r},${g},${b},${alpha})`;
}

// --- Button states ---
function updateActionButtons(status) {
  btnStart.disabled = true;
  btnStop.disabled = true;
  btnRestart.disabled = true;

  if (status === "running") {
    btnStop.disabled = false;
    btnRestart.disabled = false;
  } else if (status === "exited") {
    btnStart.disabled = false;
  }
}

let isconnectedtodaemon = false;
let wasfailed = false;
async function updateVPS() {
  try {
    const res = await fetch(`/server/stats/${containerId}`);
    const data = await res.json();
    if (!isconnectedtodaemon && res.ok) {
      isconnectedtodaemon = true;
      addLog('SUCCESS', "Connected to the Daemon");
    } else if (!isconnectedtodaemon && !wasfailed && !res.ok) {
      wasfailed = true
      showPopup("error", "Connection Failed", "Failed to connect to the Daemon")
      addLog('ERROR', "Failed to Connect to the daemon is the Node Offline?");
    }
    // Status
    const statusEl = document.getElementById("vps-status");
    let bgClass;
    switch (data.status) {
      case "running":
        bgClass = "bg-green-500";
        break;
      case "exited":
        bgClass = "bg-red-500";
        break;
      case "node missing":
        bgClass = "bg-yellow-500";
        break;
      case "error":
        bgClass = "bg-orange-500";
        break;
      default:
        bgClass = "bg-gray-500";
    }
    statusEl.textContent = data.status || "unknown";
    statusEl.className = `px-4 py-2 rounded font-semibold text-lg text-white ${bgClass}`;

    // Uptime
    document.getElementById("uptime-display").textContent =
      data.uptime || "N/A";

    // Buttons
    updateActionButtons(data.status);

    // Push chart data
    function pushData(chart, values) {
      if (!Array.isArray(values)) values = [values];
      values.forEach((val, i) => {
        chart.data.datasets[i].data.push(val);
        chart.data.datasets[i].data.shift();
      });
      chart.update();
    }
    pushData(cpuChart, data.cpuPercent ?? 0);
    pushData(ramChart, data.memoryMB ?? 0);
    pushData(networkChart, [
      data.network?.inboundKB ?? 0 / 1024,
      data.network?.outboundKB ?? 0 / 1024,
    ]);
    pushData(diskChart, data.diskUsageMB ?? 0);
  } catch (err) {
    isconnectedtodaemon = false;
    console.error("Failed to fetch VPS stats:", err);
  }
}
addLog("INFO", "Connecting to the daemon");
updateVPS();
setInterval(updateVPS, 2000);

// --- Ressh ---
<% if (!server.ssh.includes('localhost')) { %>
btnRessh.addEventListener("click", async () => {
  addLog("ACTION", "Fetching SSH session...");
  btnRessh.disabled = true;
  btnRessh.textContent = "Fetching SSH...";
  try {
    const res = await fetch(`/vps/ressh/${containerId}`, { method: "POST" });
    await res.text();
    addLog("SUCCESS", "SSH session refreshed.");
    window.location.reload();
  } catch (err) {
    addLog("ERROR", "Failed to fetch SSH info.");
    console.error("Ressh fetch error:", err);
  } finally {
    btnRessh.disabled = false;
    btnRessh.textContent = "Ressh";
  }
});
<% } %>

// --- Start/Stop/Restart ---
async function performAction(action) {
  addLog("ACTION", `${action.charAt(0).toUpperCase() + action.slice(1)}ing server...`);
  try {
    const res = await fetch(`/vps/action/${containerId}/${action}`, {
      method: "POST",
    });
    const data = await res.json();
    addLog("SUCCESS", data.message || `${action} completed`);
  } catch (err) {
    console.error(err);
    addLog("ERROR", `Failed to ${action} server`);
  }
}
btnStart.addEventListener("click", () => performAction("start"));
btnStop.addEventListener("click", () => performAction("stop"));
btnRestart.addEventListener("click", () => performAction("restart"));
</script>
</body>
</html>
